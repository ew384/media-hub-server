[0;35m
🚀 Payment API 完整功能测试
📋 测试目标:
   ✓ 验证支付订单完整流程
   ✓ 测试支付回调接口
   ✓ 验证退款功能
   ✓ 检查管理员功能
   ✓ 确认与认证服务集成
   ✓ 验证错误处理机制
🌐 Payment API: http://localhost:3102
🌐 Auth API: http://localhost:3100/api/v1
📧 测试邮箱: payment_test_1758176785@example.com
[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m3. 认证集成测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;36m🧪 测试: 注册测试用户[0m
[0;34m   请求: POST http://localhost:3100/api/v1/auth/register[0m
[0;34m   ℹ️  HTTP状态码: 201[0m
[0;34m   ℹ️  注册响应: {"user":{"id":27,"username":"支付测试用户1426","avatarUrl":null,"status":1,"createdAt":"2025-09-18T06:26:25.457Z","updatedAt":"2025-09-18T06:26:25.457Z","email":"p*********************5@example.com"},"accessToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjI3LCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU4MTc2Nzg1LCJleHAiOjE3NTgxODAzODV9._zu73LniDNVTtEsVh2uAopmd_15-N-_YjzmnvXt-cS8","refreshToken":"38d41269-bfb3-4bb6-9b72-21a2ff7012e6"}[0m
[0;34m   ℹ️  提取的Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjI3LCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU4MTc2Nzg1LCJleHAiOjE3NTgxODAzODV9._zu73LniDNVTtEsVh2uAopmd_15-N-_YjzmnvXt-cS8[0m
[0;32m   ✅ 用户注册成功，获得Token[0m
[0;34m   ℹ️  Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjI3L...[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m4. 支付订单操作测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
DEBUG: ACCESS_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjI3LCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU4MTc2Nzg1LCJleHAiOjE3NTgxODAzODV9._zu73LniDNVTtEsVh2uAopmd_15-N-_YjzmnvXt-cS8'
DEBUG: Token length = 161

[0;36m🧪 测试: 创建支付订单[0m
[0;34m   请求: POST http://localhost:3102/payment/orders[0m
[0;34m   ℹ️  HTTP状态码: 201[0m
{
  "code": 201,
  "message": "订单创建成功",
  "data": {
    "orderNo": "2025091814262582076853",
    "planInfo": {
      "planId": "monthly",
      "planName": "包月套餐",
      "originalAmount": "49.90",
      "discountAmount": "0.00",
      "finalAmount": "49.90"
    },
    "qrCodeUrl": "alipay://test_payment?orderNo=2025091814262582076853&amount=49.9&subject=%E5%8C%85%E6%9C%88%E5%A5%97%E9%A4%90",
    "qrCodeData": "data:image/png;base64,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",
    "expiresAt": "2025-09-18T06:41:25.620Z",
    "expiresIn": 900
  }
}
[0;32m   ✅ 订单创建成功[0m
[0;34m   ℹ️  订单号: 2025091814262582076853[0m

[0;36m🧪 测试: 查询订单状态[0m
[0;34m   请求: GET http://localhost:3102/payment/orders/2025091814262582076853[0m
[0;34m   ℹ️  HTTP状态码: 200[0m
[0;32m   ✅ 订单状态查询成功[0m
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "orderNo": "2025091814262582076853",
    "paymentStatus": 0,
    "statusText": "待支付",
    "planInfo": {
      "planId": "monthly",
      "planName": "包月套餐",
      "finalAmount": "49.90"
    },
    "tradeNo": null,
    "paidAt": null,
    "subscription": null
  }
}

[0;36m🧪 测试: 取消订单[0m
[0;34m   请求: PUT http://localhost:3102/payment/orders/2025091814262582076853/cancel[0m
[0;32m   ✅ 订单取消成功[0m

[0;36m🧪 测试: 获取用户订单列表[0m
[0;34m   请求: GET http://localhost:3102/payment/orders[0m
[0;34m   ℹ️  HTTP状态码: 200[0m
[0;32m   ✅ 订单列表获取成功[0m
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "list": [
      {
        "orderNo": "2025091814262582076853",
        "planId": "monthly",
        "planName": "包月套餐",
        "finalAmount": "49.90",
        "paymentMethod": "alipay",
        "paymentStatus": 3,
        "tradeNo": null,
        "paidAt": null,
        "createdAt": "2025-09-18T06:26:25.660Z",
        "expiresAt": "2025-09-18T06:41:25.620Z",
        "statusText": "已取消"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 1,
      "pages": 1
    }
  }
}

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m5. 支付回调接口测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;36m🧪 测试: 支付宝回调接口[0m
[0;34m   请求: POST http://localhost:3102/payment/callback/alipay[0m
[0;34m   ℹ️  HTTP状态码: 200[0m
[0;34m   ℹ️  响应: fail[0m
[0;32m   ✅ 支付宝回调接口正常（验证失败是预期的）[0m

[0;36m🧪 测试: 微信支付回调接口[0m
[0;34m   请求: POST http://localhost:3102/payment/callback/wechat[0m
[0;34m   ℹ️  HTTP状态码: 200[0m
[0;34m   ℹ️  响应: <xml><return_code><![CDATA[FAIL]]></return_code><return_msg><![CDATA[ERROR]]></return_msg></xml>[0m
[0;32m   ✅ 微信支付回调接口正常（验证失败是预期的）[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m6. 退款功能测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;36m🧪 测试: 申请退款[0m
[0;34m   请求: POST http://localhost:3102/payment/refunds[0m
[0;34m   ℹ️  HTTP状态码: 404[0m
{
  "code": 4002,
  "message": "订单不存在",
  "timestamp": "2025-09-18T06:26:26.147Z",
  "path": "/payment/refunds"
}
[0;32m   ✅ 退款申请接口正常（订单不存在是预期的）[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m7. 管理员接口测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;36m🧪 测试: 管理员查看所有订单[0m
[0;34m   请求: GET http://localhost:3102/admin/payment/orders[0m
[0;34m   ℹ️  HTTP状态码: 403[0m
[0;32m   ✅ 管理员订单接口正常[0m

[0;36m🧪 测试: 支付统计数据[0m
[0;34m   请求: GET http://localhost:3102/admin/payment/statistics[0m
[0;32m   ✅ 支付统计接口正常[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m8. 错误处理测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;36m🧪 测试: 未认证访问保护接口[0m
[0;34m   请求: GET http://localhost:3102/payment/orders[0m
[0;32m   ✅ 未认证访问被正确拒绝[0m

[0;36m🧪 测试: 无效参数测试[0m
[0;34m   请求: POST http://localhost:3102/payment/orders[0m
[0;32m   ✅ 无效参数错误处理正确[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m9. API文档和规范测试[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m

[0;36m🧪 测试: Swagger API文档[0m
[0;34m   请求: GET http://localhost:3102/api-docs[0m
[0;32m   ✅ API文档可访问[0m
[0;34m   ℹ️  地址: http://localhost:3102/api-docs[0m

[0;36m🧪 测试: OpenAPI规范检查[0m
[0;34m   请求: GET http://localhost:3102/api-docs-json[0m
[0;32m   ✅ OpenAPI规范格式正确[0m

[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;35m🏁 测试总结与对接准备评估[0m
[0;35m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
[0;32m✅ 通过测试: 14[0m
[0;31m❌ 失败测试: 0[0m
[0;34m📊 总计测试: 14[0m
[0;36m📈 成功率: 100%[0m

[1;33m🔧 真实支付对接准备评估:[0m
[0;32m✅ 基础功能完整性: 合格[0m
[0;32m✅ 认证集成: 正常[0m
[1;33m⚠️  环境配置: 需要完善[0m
[0;34m   - 配置真实的支付宝/微信支付密钥[0m
[0;34m   - 设置生产环境变量[0m
[0;32m✅ 回调接口: 可用[0m
[0;32m✅ 订单管理: 基础功能完整[0m
[0;32m✅ 错误处理: 机制健全[0m

[0;36m🎯 对接准备度: 100% (6/6)[0m

[0;32m🎉 Payment API 已准备好对接真实支付服务！[0m

[0;34m📋 下一步对接清单:[0m
[0;34m  1. 申请支付宝商户账号和应用[0m
[0;34m  2. 申请微信支付商户号[0m
[0;34m  3. 配置支付密钥和证书[0m
[0;34m  4. 设置支付回调URL[0m
[0;34m  5. 在测试环境验证支付流程[0m
[0;34m  6. 配置生产环境[0m
